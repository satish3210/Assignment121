trigger:
- none

pool:
  name: agent1

stages:
- stage: tflint_scan
  displayName: "TFLint Scan"
  jobs:
  - job: run_tflint
    displayName: "Run TFLint"
    continueOnError: true
    steps:
    - task: PowerShell@2
      displayName: Run TFLint
      inputs:
        targetType: 'inline'
        script: |
          $workDir = "$(System.DefaultWorkingDirectory)\environment\dev"
          $outFile = "$workDir\tflint.json"

          Write-Host "Working dir: $workDir"
          Write-Host "Output file: $outFile"

          # Init plugins
          tflint --init

          # Run tflint and write output EXACTLY where we publish from
          tflint --chdir="$workDir" --recursive --format json > "$outFile"

          # Do not fail pipeline on lint issues
          if ($LASTEXITCODE -ne 0) {
            Write-Host "TFLint issues found (expected). Continuing pipeline."
            exit 0
          }

    - task: PublishPipelineArtifact@1
      displayName: Publish TFLint Report
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)\environment\dev\tflint.json'
        artifact: 'tflint-result'
        publishLocation: 'pipeline'
