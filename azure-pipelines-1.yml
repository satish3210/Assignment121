trigger:
- none

pool:
  name: agent1

stages:
# ================= TFLINT SCAN =================
- stage: tflint_scan
  displayName: "TFLint Scan"
  jobs:
  - job: run_tflint
    displayName: "Run TFLint"
    continueOnError: true
    steps:
    - task: PowerShell@2
      displayName: Run TFLint
      inputs:
        targetType: 'inline'
        script: |
          $workDir = "$(System.DefaultWorkingDirectory)\environment\dev"
          tflint --init
          tflint --chdir="$workDir" --recursive --format json > "$workDir\tflint.json"
          if ($LASTEXITCODE -ne 0) { exit 0 }

    - task: PublishPipelineArtifact@1
      displayName: Publish TFLint Report
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)\environment\dev\tflint.json'
        artifact: 'tflint-result'
        publishLocation: 'pipeline'